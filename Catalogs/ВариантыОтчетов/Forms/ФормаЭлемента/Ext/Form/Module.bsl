
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	СписокПользователей = "";
	СписокПодсистем = "";
	
	Для каждого Подсистема из Метаданные.Подсистемы Цикл
		
		Если Не Подсистема.ВключатьВКомандныйИнтерфейс тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаПодсистемы = ДеревоПодсистем.ПолучитьЭлементы().Добавить();
		
		СтрокаПодсистемы.ПутьКПодсистеме = Подсистема.Имя;
		СтрокаПодсистемы.Название        = Подсистема.Синоним;
		
		МассивСтрок                              = Объект.Подсистемы.НайтиСтроки(Новый Структура("Подсистема", СтрокаПодсистемы.ПутьКПодсистеме + "\" + Подсистема.Имя));
		СтрокаПодсистемы.Использование = МассивСтрок.Количество() > 0;
		Если СтрокаПодсистемы.Использование тогда
			СписокПодсистем = СписокПодсистем + Подсистема.Синоним + ", ";
			СтрокаПодсистемы.Предопределенная = МассивСтрок[0].Предопределенная;
		КонецЕсли;
		
		ДобавитьДеревоПодсистем(Подсистема, СтрокаПодсистемы, СписокПодсистем);
		
	КонецЦикла;
	
	ВиртуальныеПодсистемы = ВариантыОтчетов.ПолучитьВиртуальныеПодсистемы(Подсистема);
	
	Для каждого Подсистема из ВиртуальныеПодсистемы Цикл
		
		СтрокаПодсистемы = ДеревоПодсистем.Строки.Добавить();
		
		СтрокаПодсистемы.ПутьКПодсистеме = Подсистема.Значение;
		СтрокаПодсистемы.Название        = Подсистема.Представлени;
		
		МассивСтрок                              = Объект.Подсистемы.НайтиСтроки(Новый Структура("Подсистема", Подсистема.Значение));
		СтрокаПодсистемы.Использование = МассивСтрок.Количество() > 0;
		Если СтрокаПодсистемы.Использование тогда
			СписокПодсистем = СписокПодсистем + Подсистема.Синоним + ", ";
			СтрокаПодсистемы.Предопределенная = МассивСтрок[0].Предопределенная;
		КонецЕсли;
		
		ДобавитьДеревоВиртуальныхПодсистем(Подсистема.Значение, СтрокаПодсистемы, СписокПодсистем);
		
	КонецЦикла;
	
	
	Элементы.Использование.Заголовок = ОписаниеПользователей();
	Элементы.Подсистемы.Заголовок    = ОписаниеПодсистем();
	
КонецПроцедуры

Функция ОписаниеПользователей()
	
	ОписаниеПользователя = "";
	Если Объект.Видимость тогда
		ОписаниеПользователя = "все" + ?(Объект.НастройкаВидимости.Количество() > 0, " кроме: ", "  ");
	Иначе
		ОписаниеПользователя = "";
	КонецЕсли;
	Для каждого СтрокаПользователя из Объект.НастройкаВидимости Цикл
		ОписаниеПользователя = ОписаниеПользователя + СтрокаПользователя.Пользователь + ", ";
	КонецЦикла;
	ОписаниеПользователя = Лев(ОписаниеПользователя, СтрДлина(ОписаниеПользователя)-2);
	
	Возврат ОписаниеПользователя;
	
КонецФункции

Функция ОписаниеПодсистем()
	
	СписокПодсистем = "";
	
	Для каждого Подсистема из Объект.Подсистемы Цикл
		СписокПодсистем = СписокПодсистем + Подсистема.Название + ", ";
	КонецЦикла;
	
	Возврат Лев(СписокПодсистем, СтрДлина(СписокПодсистем)-2)
	
КонецФункции

Процедура ДобавитьДеревоПодсистем(Подсистема, СтрокаПодсистемы, СписокПодсистем)
	
	Для каждого ПодсистемаПодчиненная из Подсистема.Подсистемы Цикл
		
		Если Не ПодсистемаПодчиненная.ВключатьВКомандныйИнтерфейс тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаПодсистемыПодчиненой               = СтрокаПодсистемы.ПолучитьЭлементы().Добавить();
		СтрокаПодсистемыПодчиненой.Название      = ПодсистемаПодчиненная.Синоним;
		МассивСтрок                              = Объект.Подсистемы.НайтиСтроки(Новый Структура("Подсистема", СтрокаПодсистемы.ПутьКПодсистеме + "\" + ПодсистемаПодчиненная.Имя));
		СтрокаПодсистемыПодчиненой.Использование = МассивСтрок.Количество() > 0;
		Если СтрокаПодсистемыПодчиненой.Использование тогда
			СписокПодсистем = СписокПодсистем + ПодсистемаПодчиненная.Синоним + ", ";
			СтрокаПодсистемыПодчиненой.Предопределенная = МассивСтрок[0].Предопределенная;
		КонецЕсли;
		СтрокаПодсистемыПодчиненой.ПутьКПодсистеме = СтрокаПодсистемы.ПутьКПодсистеме + "\" + ПодсистемаПодчиненная.Имя;
		ДобавитьДеревоПодсистем(ПодсистемаПодчиненная, СтрокаПодсистемыПодчиненой, СписокПодсистем);
		
	КонецЦикла;
	
	ВиртуальныеПодсистемы = ВариантыОтчетов.ПолучитьВиртуальныеПодсистемы(СтрокаПодсистемы.ПутьКПодсистеме);
	
	Для каждого ПодсистемаПодчиненная из ВиртуальныеПодсистемы Цикл
		
		СтрокаПодсистемыПодчиненой               = СтрокаПодсистемы.ПолучитьЭлементы().Добавить();
		СтрокаПодсистемыПодчиненой.Название      = ПодсистемаПодчиненная.Представление;
		МассивСтрок                              = Объект.Подсистемы.НайтиСтроки(Новый Структура("Подсистема", ПодсистемаПодчиненная.Значение));
		СтрокаПодсистемыПодчиненой.Использование = МассивСтрок.Количество() > 0;
		Если СтрокаПодсистемыПодчиненой.Использование тогда
			СписокПодсистем = СписокПодсистем + ПодсистемаПодчиненная.Синоним + ", ";
			СтрокаПодсистемыПодчиненой.Предопределенная = МассивСтрок[0].Предопределенная;
		КонецЕсли;
		СтрокаПодсистемыПодчиненой.ПутьКПодсистеме = ПодсистемаПодчиненная.Значение;
		ДобавитьДеревоВиртуальныхПодсистем(ПодсистемаПодчиненная.Значение, СтрокаПодсистемыПодчиненой, СписокПодсистем);
		
	КонецЦикла;
КонецПроцедуры


Процедура ДобавитьДеревоВиртуальныхПодсистем(Подсистема, СтрокаПодсистемы, СписокПодсистем)
	
	ВиртуальныеПодсистемы = ВариантыОтчетов.ПолучитьВиртуальныеПодсистемы(Подсистема);
	
	Для каждого ПодсистемаПодчиненная из ВиртуальныеПодсистемы Цикл
		
		СтрокаПодсистемыПодчиненой               = СтрокаПодсистемы.ПолучитьЭлементы().Добавить();
		СтрокаПодсистемыПодчиненой.Название      = ПодсистемаПодчиненная.Представление;
		МассивСтрок                              = Объект.Подсистемы.НайтиСтроки(Новый Структура("Подсистема", ПодсистемаПодчиненная.Значение));
		СтрокаПодсистемыПодчиненой.Использование = МассивСтрок.Количество() > 0;
		Если СтрокаПодсистемыПодчиненой.Использование тогда
			СписокПодсистем = СписокПодсистем + ПодсистемаПодчиненная.Синоним + ", ";
			СтрокаПодсистемыПодчиненой.Предопределенная = МассивСтрок[0].Предопределенная;
		КонецЕсли;
		СтрокаПодсистемыПодчиненой.ПутьКПодсистеме = ПодсистемаПодчиненная.Значение;
		ДобавитьДеревоВиртуальныхПодсистем(ПодсистемаПодчиненная.Значение, СтрокаПодсистемыПодчиненой, СписокПодсистем);
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура НастроитьВидимостьПользователей(Команда)
	
	СписокПользователей = Новый СписокЗначений;
	Для каждого СтрокаПользователь из Объект.НастройкаВидимости Цикл
		СписокПользователей.Добавить(СтрокаПользователь.Пользователь,, НЕ Объект.Видимость);
	КонецЦикла;
	
	ПараметрыФормы = Новый Структура("Видимость, Пользователи", Объект.Видимость, СписокПользователей);
	Структура = ОткрытьФормуМодально("Справочник.ВариантыОтчетов.Форма.РедактированиеВидимости", ПараметрыФормы, ЭтаФорма);
	Если Структура = Неопределено тогда
		Возврат;
	КонецЕсли;
	
	СписокПользователей = Структура.Пользователи;
	
	Объект.НастройкаВидимости.Очистить();
	
	Объект.Видимость = Структура.Видимость;
	
	Для каждого ЭлементПользователи из СписокПользователей Цикл
		СтрокаРоли              = Объект.НастройкаВидимости.Добавить();
		СтрокаРоли.Пользователь = ЭлементПользователи.Значение;
	КонецЦикла;
	
	Элементы.Использование.Заголовок = ОписаниеПользователей();
	
	ЭтаФорма.Модифицированность = Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура НастроитьПодсистемы(Команда)
	
	ПараметрыФормы = Новый Структура("ДеревоПодсистем", ДеревоПодсистем);
	
	ВозвращаемыеПараметры = ОткрытьФормуМодально("Справочник.ВариантыОтчетов.Форма.РедактированиеПодсистемы", ПараметрыФормы, ЭтаФорма);
	
	Если ВозвращаемыеПараметры <> Неопределено тогда
		Объект.Подсистемы.Очистить();
		Для каждого ОписаниеПодсистема из ВозвращаемыеПараметры.СписокПодсистем Цикл
			СтрокаПодсистемы = Объект.Подсистемы.Добавить();
			СтрокаПодсистемы.Подсистема            = ОписаниеПодсистема.Подсистема;
			СтрокаПодсистемы.Название              = ОписаниеПодсистема.Название;
			СтрокаПодсистемы.Предопределенная = ОписаниеПодсистема.Предопределенная;
		КонецЦикла;
		
		Элементы.Подсистемы.Заголовок = ОписаниеПодсистем();
		
		ПоместитьДеревоЗначенийВформу(ВозвращаемыеПараметры.ДеревоПодсистем);
		ЭтаФорма.Модифицированность = Истина;
		
	КонецЕсли;

	
КонецПроцедуры

&НаСервере
Процедура ПоместитьДеревозначенийВформу(ДеревоПодсистем)
	
	ДеревоПодсистемЗначение = ДанныеФормыВЗначение(ДеревоПодсистем, Тип("ДеревоЗначений"));
	ЗначениеВРеквизитФормы(ДеревоПодсистемЗначение, "ДеревоПодсистем");
	
КонецПроцедуры 

